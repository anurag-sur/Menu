<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AR Food Menu - Debug</title>

  <!-- DO NOT CHANGE -->
  <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.3.2/aframe/build/aframe-ar.js"></script>

  <style>
    body { margin:0; overflow:hidden; font-family:Arial; }

    .btn {
      position:absolute;
      bottom:20px;
      padding:10px 16px;
      background:rgba(0,0,0,0.85);
      color:white;
      border:none;
      border-radius:10px;
      font-size:16px;
      z-index:999;
    }

    #left { left:15px; }
    #right { right:15px; }
    #rate { left:50%; transform:translateX(-50%); }

    #info {
      position:absolute;
      top:20px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(0,0,0,0.75);
      color:white;
      padding:8px 14px;
      border-radius:12px;
      font-size:14px;
      z-index:999;
      max-width:90%;
      text-align:center;
    }

    #debug {
      position:absolute;
      top:60px;
      left:10px;
      right:10px;
      background:rgba(255,0,0,0.85);
      color:white;
      padding:8px;
      border-radius:8px;
      font-size:11px;
      z-index:999;
      max-height:200px;
      overflow-y:auto;
    }

    #ratingMenu {
      position:absolute;
      bottom:80px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(0,0,0,0.85);
      padding:8px 14px;
      border-radius:12px;
      display:none;
      z-index:1000;
    }

    .star {
      font-size:25px;
      color:white;
      cursor:pointer;
    }
  </style>
</head>

<body>

<div id="info">Burger • ₹149</div>
<div id="debug">Initializing...</div>

<button id="left" class="btn">◀</button>
<button id="rate" class="btn">Rate</button>
<button id="right" class="btn">▶</button>

<div id="ratingMenu">
  <span class="star" data-star="1">★</span>
  <span class="star" data-star="2">★</span>
  <span class="star" data-star="3">★</span>
  <span class="star" data-star="4">★</span>
  <span class="star" data-star="5">★</span>
</div>

<a-scene embedded vr-mode-ui="enabled:false"
         arjs="sourceType:webcam; debugUIEnabled:false;">

  <!-- LIGHTS (REQUIRED FOR GLB) -->
  <a-entity light="type: ambient; intensity: 0.8"></a-entity>
  <a-entity light="type: directional; intensity: 0.4" position="1 2 1"></a-entity>

  <a-entity camera></a-entity>
  <a-entity id="holder" position="0 0 -4"></a-entity>

</a-scene>


<script>
const debugDiv = document.getElementById("debug");
let debugLog = [];

function log(msg) {
  console.log(msg);
  debugLog.push(msg);
  if (debugLog.length > 10) debugLog.shift();
  debugDiv.innerHTML = debugLog.join('<br>');
}

log('Script started');
log('Location: ' + window.location.href);

const foods = [
  // Working test models to verify setup
  { model:"https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF-Binary/Duck.glb", name:"Duck (Test)", price:"₹0", scale:0.01 },
  { model:"https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Avocado/glTF-Binary/Avocado.glb", name:"Avocado (Test)", price:"₹0", scale:20 },
  { model:"models/burger.glb", name:"Burger", price:"₹149", scale:0.4 },
  { model:"models/pizza.glb",  name:"Pizza",  price:"₹299", scale:2.0 },
  { model:"models/fries.glb",  name:"Fries",  price:"₹99",  scale:0.5 }
];

const holder = document.getElementById("holder");
const info = document.getElementById("info");
const ratingMenu = document.getElementById("ratingMenu");

let index = 0;
let model = document.createElement("a-entity");
holder.appendChild(model);

let scale = foods[0].scale;
let yaw = 0, pitch = 0;
let autoRotate = true;

log('Elements initialized');

/* CHECK IF FILES EXIST */
async function checkFile(url) {
  try {
    const response = await fetch(url, { method: 'HEAD' });
    log(`${url}: ${response.status} ${response.statusText}`);
    return response.ok;
  } catch (e) {
    log(`${url}: ERROR - ${e.message}`);
    return false;
  }
}

/* LOAD FOOD */
function loadFood(i) {
  log(`Loading: ${foods[i].model}`);
  
  model.setAttribute("gltf-model", foods[i].model);
  scale = foods[i].scale;
  model.object3D.scale.set(scale,scale,scale);
  yaw = pitch = 0;
  info.innerText = `${foods[i].name} • ${foods[i].price}`;
  
  // Check if model exists
  checkFile(foods[i].model);
}

// Listen for model load events
model.addEventListener('model-loaded', () => {
  log('✓ Model loaded successfully!');
});

model.addEventListener('model-error', (e) => {
  log('✗ Model load error: ' + JSON.stringify(e.detail));
});

log('Starting initial load...');
loadFood(0);

// Check all files
setTimeout(() => {
  log('Checking all model files...');
  foods.forEach(f => checkFile(f.model));
}, 1000);

/* SWITCH FOOD */
left.onclick = () => {
  index = (index - 1 + foods.length) % foods.length;
  loadFood(index);
};

right.onclick = () => {
  index = (index + 1) % foods.length;
  loadFood(index);
};

/* RATING */
rate.onclick = () => {
  ratingMenu.style.display =
    ratingMenu.style.display === "block" ? "none" : "block";
};

document.querySelectorAll(".star").forEach(s=>{
  s.onclick = ()=>{
    alert(`Rated ${s.dataset.star} star(s)`);
    ratingMenu.style.display="none";
  };
});

/* TOUCH CONTROLS */
let dragging=false,lastX=0,lastY=0,zoomStart=0;

function pinch(t){
  const dx=t[0].clientX-t[1].clientX;
  const dy=t[0].clientY-t[1].clientY;
  return Math.sqrt(dx*dx+dy*dy);
}

document.addEventListener("touchstart",e=>{
  autoRotate=false;
  if(e.touches.length===1){
    dragging=true;
    lastX=e.touches[0].clientX;
    lastY=e.touches[0].clientY;
  }
  if(e.touches.length===2){
    zoomStart=pinch(e.touches);
  }
});

document.addEventListener("touchmove",e=>{
  if(e.touches.length===2){
    const d=pinch(e.touches);
    scale*=d/zoomStart;
    scale=Math.max(0.2,Math.min(2.5,scale));
    model.object3D.scale.set(scale,scale,scale);
    zoomStart=d;
    return;
  }
  if(dragging){
    yaw+=(e.touches[0].clientX-lastX)*0.01;
    pitch+=(e.touches[0].clientY-lastY)*0.01;
    lastX=e.touches[0].clientX;
    lastY=e.touches[0].clientY;
    model.object3D.rotation.set(pitch,yaw,0);
  }
});

document.addEventListener("touchend",()=>{
  dragging=false;
  setTimeout(()=>autoRotate=true,3000);
});

/* AUTO ROTATE */
AFRAME.registerComponent("spin",{
  tick:()=>{
    if(autoRotate){
      yaw+=0.003;
      model.object3D.rotation.y=yaw;
    }
  }
});
model.setAttribute("spin","");

log('Setup complete');
</script>

</body>
</html>
